<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Blog — ETA Games</title>
<link rel="stylesheet" href="tvh.css">

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCiWCjKAsNYLnDJT1o3r_E3tGLyYTasDPc",
  authDomain: "etagames-b5d6a.firebaseapp.com",
  projectId: "etagames-b5d6a",
  messagingSenderId: "809625655346",
  appId: "1:809625655346:web:3010a62960fde91787842b"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
</script>

<style>
.card-tvhouse { background:var(--card,#1a1a1a); padding:15px; border-radius:12px; margin-bottom:20px; box-shadow:0 4px 10px rgba(0,0,0,0.5);}
.btn { background:var(--accent,#ff3c3c); color:#fff; border:none; padding:10px; width:100%; border-radius:6px; cursor:pointer; margin-top:5px;}
.btn:hover { opacity:0.8;}
textarea { width:100%; padding:8px; border-radius:6px; margin-bottom:5px; resize:none; background:#222; color:#fff; border:1px solid #444; }
.post-header { display:flex; align-items:center; gap:10px; margin-bottom:10px;}
.post-header img { width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid var(--accent);}
.media-link { color:#4da6ff; word-break:break-word; display:block; margin-top:5px; }
.delete-btn, .like-btn { background:#aa0000; width:auto; padding:5px 10px; font-size:0.9em; margin-top:5px; cursor:pointer; margin-right:5px; color: white; border: none; border-radius: 4px;}
.like-btn { background:#4da6ff;} /* Blu per il like */
.like-btn.liked { background:#555; } /* Grigio se già messo like */
.sidebar { width:260px; position:sticky; top:20px;}
</style>

</head>
<body>

<header>
<div class="container">
<nav>
<div class="brand">
<img src="img/channels4_profile.jpg" class="logo-img">
<div>
<div>ETA Games</div>
<div class="muted" style="font-size:12px">Blog</div>
</div>
</div>
<div class="nav-links">
<a href="index.html" >Home</a>
<a href="games.html">Giochi</a>
<a href="extra.html">Extra</a>
<a href="login.html">Profilo</a>
<a href="blog.html" class="active">Blog</a>
</div>
</nav>
</div>
</header>

<section class="container" style="display:flex; gap:20px">

<aside class="card-tvhouse sidebar">
<h3>Top Post</h3>
<div id="topPosts"></div>
</aside>

<div style="flex:1">

<div class="card-tvhouse">
<h2>Nuovo Post</h2>
<div id="postFormContainer"></div>
</div>

<div id="postsContainer"></div>

</div>
</section>

  <footer>
    <div class="container">
      <div class="footer-grid">
        <div>
          <strong>ETA Games</strong>
          <div class="muted">© ETA Games — Tutti i diritti riservati</div>
        </div>
        <div class="socials muted">
          <a href="https://discord.gg/Da7sq3Mwpw" target="_blank">Discord</a>
          <a href="https://www.youtube.com/@HGames_studio" target="_blank">YouTube</a>
          <a href="https://www.instagram.com/eta.games_" target="_blank">Instagram</a>
        </div>
      </div>
    </div>
  </footer>

<script>
// 1. GESTIONE LOGIN / LOGOUT UI
auth.onAuthStateChanged(async user => {
  const formContainer = document.getElementById('postFormContainer');
  if (!user) {
    formContainer.innerHTML = '<p>Accedi o registrati per scrivere post e mettere like.</p>';
  } else {
    formContainer.innerHTML = `
      <textarea id="postText" rows="3" placeholder="Scrivi il tuo post..."></textarea>
      <input type="text" id="mediaLink" placeholder="Link immagine/video (opzionale)">
      <button id="createPost" class="btn">Pubblica</button>
    `;
    document.getElementById('createPost').onclick = createPost;
  }
  // Carica i post in ogni caso
  loadPosts();
});

// 2. RECUPERO INFO UTENTE (Con correzione per "Anonimo")
async function getUserInfo(uid) {
  try {
    // Prima cerchiamo nel Database 'users'
    const doc = await db.collection('users').doc(uid).get();
    
    if (doc.exists) {
      const data = doc.data();
      return {
        name: data.displayName || "Utente Senza Nome",
        photo: data.photoBase64 || "img/default-avatar.png"
      };
    }
    
    // FALLBACK: Se non troviamo il doc, ma l'utente è quello loggato ora
    if (auth.currentUser && auth.currentUser.uid === uid && auth.currentUser.displayName) {
        return {
            name: auth.currentUser.displayName,
            photo: "img/default-avatar.png"
        };
    }

  } catch (error) {
    console.error("Errore user info", error);
  }

  // Default se non troviamo nulla
  return { name: "Anonimo", photo: "img/default-avatar.png" };
}

// 3. CARICAMENTO POST
async function loadPosts() {
  const container = document.getElementById('postsContainer');
  const topContainer = document.getElementById('topPosts');
  container.innerHTML = ''; 
  topContainer.innerHTML = '';

  const snapshot = await db.collection('posts').orderBy('created', 'desc').get();
  
  // Trasformiamo i dati (aggiungendo info utente e like)
  const postsArray = await Promise.all(snapshot.docs.map(async doc => {
    const data = doc.data();
    const likedBy = data.likedBy || []; // Assicuriamoci che sia un array
    const userInfo = await getUserInfo(data.userId);
    
    return { 
        ...data, 
        id: doc.id, 
        likes: likedBy.length, 
        likedByArray: likedBy,
        userName: userInfo.name, 
        userPhoto: userInfo.photo 
    };
  }));

  // Renderizziamo i post nella pagina
  postsArray.forEach(p => {
    const postDiv = document.createElement('div');
    postDiv.className = 'card-tvhouse';
    
    // Controlliamo se l'utente attuale ha messo like
    const currentUser = auth.currentUser;
    const hasLiked = currentUser && p.likedByArray.includes(currentUser.uid);

    postDiv.innerHTML = `
      <div class="post-header">
        <img src="${p.userPhoto}">
        <strong>${p.userName}</strong>
      </div>
      <div class="post-content">${p.text}</div>
      ${p.mediaLink ? `<a href="${p.mediaLink}" target="_blank" class="media-link">Allegato Media</a>` : ''}
      <div style="margin-top:8px; font-size:0.9em; color:#bbb;">Like: <span>${p.likes}</span></div>
    `;

    // Bottone Like (Solo se loggato)
    if (currentUser) {
      const likeBtn = document.createElement('button');
      likeBtn.textContent = hasLiked ? 'Togli Like' : 'Mi Piace';
      likeBtn.className = hasLiked ? 'like-btn liked' : 'like-btn'; // Cambio classe CSS
      
      // Quando clicco chiamo toggleLike
      likeBtn.onclick = () => toggleLike(p.id, hasLiked);
      postDiv.appendChild(likeBtn);
    }

    // Bottone Elimina (Solo se è il mio post)
    if (currentUser && currentUser.uid === p.userId) {
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Elimina';
      delBtn.className = 'delete-btn';
      delBtn.onclick = () => deletePost(p.id);
      postDiv.appendChild(delBtn);
    }

    container.appendChild(postDiv);
  });

  // Gestione Top Posts (ordinati per like)
  const sortedPosts = [...postsArray].sort((a, b) => b.likes - a.likes);
  sortedPosts.slice(0, 5).forEach(p => {
    const div = document.createElement('div');
    div.style.marginBottom = '10px';
    div.style.borderBottom = '1px solid #333';
    div.style.paddingBottom = '5px';
    div.innerHTML = `<strong>${p.userName}</strong><br>
                     <span style="font-size:0.85em; color:#aaa;">${p.text.substring(0, 40)}...</span> 
                     <br>❤️ ${p.likes}`;
    topContainer.appendChild(div);
  });
}

// 4. CREAZIONE POST
async function createPost() {
  const text = document.getElementById('postText').value.trim();
  const mediaLink = document.getElementById('mediaLink').value.trim();
  
  if (!text) return alert("Scrivi qualcosa prima di pubblicare.");
  
  const user = auth.currentUser;
  
  await db.collection('posts').add({
    text,
    mediaLink: mediaLink || '',
    userId: user.uid,
    likedBy: [], // Parte con 0 like
    created: firebase.firestore.FieldValue.serverTimestamp()
  });
  
  document.getElementById('postText').value = '';
  document.getElementById('mediaLink').value = '';
  loadPosts();
}

// 5. ELIMINAZIONE POST
async function deletePost(postId) {
  if (confirm("Sei sicuro di voler eliminare questo post?")) {
    await db.collection('posts').doc(postId).delete();
    loadPosts();
  }
}

// 6. TOGGLE LIKE (Metti / Togli)
async function toggleLike(postId, hasLiked) {
  const user = auth.currentUser;
  if (!user) return;

  const postRef = db.collection('posts').doc(postId);

  if (hasLiked) {
    // Se c'è già il like, lo rimuoviamo
    await postRef.update({
      likedBy: firebase.firestore.FieldValue.arrayRemove(user.uid)
    });
  } else {
    // Se non c'è, lo aggiungiamo
    await postRef.update({
      likedBy: firebase.firestore.FieldValue.arrayUnion(user.uid)
    });
  }
  
  // Ricarichiamo i post per vedere il numero aggiornato
  loadPosts();
}
</script>

</body>
</html>