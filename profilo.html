<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Account — ETA Games</title>
  <link rel="stylesheet" href="tvh.css">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>

<body>

<header>
  <div class="container">
    <nav>
      <div class="brand">
        <img src="img/channels4_profile.jpg" class="logo-img">
        <div>
          <div>ETA Games</div>
          <div class="muted" style="font-size:12px">Profilo utente</div>
        </div>
      </div>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="games.html">Giochi</a>
        <a href="extra.html">Extra</a>
        <a href="profilo.html" class="active">Profilo</a>
      </div>
    </nav>
  </div>
</header>

<section class="container" style="display:flex;gap:20px">

  <!-- SIDEBAR -->
  <aside class="card" style="width:260px;height:fit-content;position:sticky;top:20px">
    <h3>Account</h3>
    <p><a href="#overview" class="badge">Panoramica</a></p>
    <p><a href="#base" class="badge">Dati base</a></p>
    <p><a href="#security" class="badge">Sicurezza</a></p>
    <p><a href="#privacy" class="badge">Privacy</a></p>
  </aside>

  <!-- CONTENT -->
  <div style="flex:1">

    <!-- OVERVIEW -->
    <div class="card-tvhouse" id="overview" style="margin-bottom:20px">
      <h2>Panoramica profilo</h2>
      <p><strong>Username:</strong> <span id="username">Caricamento...</span></p>
      <p><strong>Email:</strong> <span id="email">Caricamento...</span></p>
      <p><strong>Account creato:</strong> <span id="created">Caricamento...</span></p>
      <p><strong>Ultimo accesso:</strong> <span id="lastLogin">Caricamento...</span></p>
      <button id="logoutBtn" class="btn" style="margin-top:10px;width:100%;">Logout</button>
    </div>

    <!-- DATI BASE -->
    <div class="card-tvhouse" id="base" style="margin-bottom:20px">
      <h2>Dati base</h2>

      <!-- Cambia Username -->
      <div style="margin-bottom:10px">
        <label for="newUsername">Nuovo username:</label>
        <input type="text" id="newUsername" placeholder="Inserisci nuovo username" style="width:100%;padding:6px;margin:4px 0">
        <button id="updateUsernameBtn" class="btn" style="width:100%">Aggiorna Username</button>
      </div>

      <!-- Cambia Email -->
      <div style="margin-bottom:10px">
        <label for="newEmail">Nuova email:</label>
        <input type="email" id="newEmail" placeholder="Inserisci nuova email" style="width:100%;padding:6px;margin:4px 0">
        <button id="updateEmailBtn" class="btn" style="width:100%">Aggiorna Email</button>
      </div>

      <!-- Cambia Password -->
      <div style="margin-bottom:10px">
        <label for="newPassword">Nuova password:</label>
        <input type="password" id="newPassword" placeholder="Inserisci nuova password" style="width:100%;padding:6px;margin:4px 0">
        <button id="updatePasswordBtn" class="btn" style="width:100%">Aggiorna Password</button>
      </div>
    </div>

    <!-- SICUREZZA -->
    <div class="card-tvhouse" id="security" style="margin-bottom:20px">
      <h2>Sicurezza</h2>
      <button id="sendVerification" class="btn" style="width:100%;">Verifica email</button>
    </div>

    <!-- PRIVACY -->
    <div class="card-tvhouse" id="privacy" style="margin-bottom:20px">
      <h2>Privacy</h2>
      <button id="deleteAccount" class="btn" style="width:100%;">Elimina account</button>
    </div>

</section>

<footer>
  <div class="container footer-grid">
    <div>
      <strong>ETA Games</strong>
      <div class="muted">© ETA Games — Tutti i diritti riservati</div>
    </div>
  </div>
</footer>

<script>
const auth = firebase.auth();
const db = firebase.firestore();

/* ===============================
   LOGIN + DATI UTENTE
================================ */
auth.onAuthStateChanged(user => {
  if (!user) return window.location.href = "login.html";

  document.getElementById('username').textContent = user.displayName || "Non impostato";
  document.getElementById('email').textContent = user.email;
  document.getElementById('created').textContent =
    new Date(user.metadata.creationTime).toLocaleDateString();
  document.getElementById('lastLogin').textContent =
    new Date(user.metadata.lastSignInTime).toLocaleDateString();
});

/* ===============================
   LOGOUT
================================ */
document.getElementById("logoutBtn").onclick = () => {
  auth.signOut().then(() => location.href = "login.html");
};

/* ===============================
   AGGIORNA USERNAME
================================ */
document.getElementById('updateUsernameBtn').addEventListener('click', async () => {
  const user = auth.currentUser;
  const newUsername = document.getElementById('newUsername').value.trim();
  if (!newUsername) return alert("Inserisci un username valido.");

  try {
    await user.updateProfile({ displayName: newUsername });
    await db.collection('users').doc(user.uid).set({ displayName: newUsername }, { merge: true });
    document.getElementById('username').textContent = newUsername;
    alert("Username aggiornato!");
  } catch (err) {
    alert("Errore: " + err.message);
  }
});

/* ===============================
   AGGIORNA EMAIL
================================ */
document.getElementById('updateEmailBtn').addEventListener('click', async () => {
  const user = auth.currentUser;
  const newEmail = document.getElementById('newEmail').value.trim();
  if (!newEmail) return alert("Inserisci un'email valida.");

  try {
    await user.updateEmail(newEmail);
    document.getElementById('email').textContent = newEmail;
    alert("Email aggiornata! Verifica se richiesto.");
  } catch (err) {
    alert("Errore: " + err.message);
  }
});

/* ===============================
   AGGIORNA PASSWORD
================================ */
document.getElementById('updatePasswordBtn').addEventListener('click', async () => {
  const user = auth.currentUser;
  const newPassword = document.getElementById('newPassword').value.trim();
  if (!newPassword) return alert("Inserisci una password valida (min 6 caratteri).");

  try {
    await user.updatePassword(newPassword);
    alert("Password aggiornata con successo!");
  } catch (err) {
    alert("Errore: " + err.message);
  }
});

/* ===============================
   VERIFICA EMAIL
================================ */
document.getElementById('sendVerification').addEventListener('click', () => {
  auth.currentUser.sendEmailVerification()
    .then(() => alert("Email di verifica inviata!"))
    .catch(err => alert(err.message));
});

/* ===============================
   ELIMINA ACCOUNT
================================ */
document.getElementById('deleteAccount').addEventListener('click', () => {
  if (confirm("Sei sicuro di voler eliminare l'account? Questa azione non può essere annullata.")) {
    auth.currentUser.delete()
      .then(() => { alert("Account eliminato."); window.location.href="login.html"; })
      .catch(err => alert(err.message));
  }
});
</script>

</body>
</html>
