<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Account â€” ETA Games</title>
<link rel="stylesheet" href="tvh.css">

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCiWCjKAsNYLnDJT1o3r_E3tGLyYTasDPc",
  authDomain: "etagames-b5d6a.firebaseapp.com",
  projectId: "etagames-b5d6a",
  messagingSenderId: "809625655346",
  appId: "1:809625655346:web:3010a62960fde91787842b"
};
firebase.initializeApp(firebaseConfig);
</script>
</head>

<body>

<header>
<div class="container">
<nav>
  <div class="brand">
    <img src="img/channels4_profile.jpg" class="logo-img">
    <div>
      <div>ETA Games</div>
      <div class="muted" style="font-size:12px">Profilo utente</div>
    </div>
  </div>
  <div class="nav-links">
    <a href="index.html">Home</a>
    <a href="games.html">Giochi</a>
    <a href="extra.html">Extra</a>
    <a href="profilo.html" class="active">Profilo</a>
  </div>
</nav>
</div>
</header>

<section class="container" style="display:flex;gap:20px">

<aside class="card" style="width:260px;position:sticky;top:20px">
  <h3>Account</h3>
  <p><a href="#overview" class="badge">Panoramica</a></p>
  <p><a href="#base" class="badge">Dati base</a></p>
  <p><a href="#securityPrivacy" class="badge">Sicurezza e Privacy</a></p>
  <p><a href="#extraFeatures" class="badge">Funzioni extra</a></p>
</aside>

<div style="flex:1">

<div class="card-tvhouse" id="overview" style="margin-bottom:20px">
  <h2>Panoramica profilo</h2>
  <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;">
    <img id="profileImg" src="img/default-avatar.png" style="width:90px;height:90px;border-radius:50%;object-fit:cover;border:2px solid var(--accent);">
    <div>
      <input type="file" id="profileUpload" accept="image/*" style="display:none">
      <button class="btn" onclick="document.getElementById('profileUpload').click()">Cambia immagine profilo</button>
    </div>
  </div>
  <p><strong>Username:</strong> <span id="username">Caricamento...</span></p>
  <p><strong>Email:</strong> <span id="email">Caricamento...</span> <button id="copyEmail" class="btn" style="padding:2px 6px;font-size:12px;">Copia</button></p>
  <p><strong>Account creato:</strong> <span id="created">Caricamento...</span></p>
  <p><strong>Ultimo accesso:</strong> <span id="lastLogin">Caricamento...</span></p>
  <p><strong>Giorni registrato:</strong> <span id="daysRegistered">Calcolo...</span></p>
  <button id="logoutBtn" class="btn" style="margin-top:10px;width:100%;">Logout</button>
</div>

<div class="card-tvhouse" id="base" style="margin-bottom:20px">
  <h2>Dati base</h2>
  <button id="toggleUsername" class="btn" style="width:100%;">Cambia username</button>
  <div id="usernameForm" style="display:none;margin-top:8px;">
    <input id="newUsername" placeholder="Nuovo username" style="width:100%;padding:8px;">
    <button id="saveUsername" class="btn" style="width:100%;">Salva</button>
  </div>
</div>

<div class="card-tvhouse" id="securityPrivacy" style="margin-bottom:20px">
  <h2>Sicurezza e Privacy</h2>
  <button id="sendVerification" class="btn" style="width:100%;">Verifica email</button>
  <button id="deleteAccount" class="btn" style="width:100%;margin-top:8px;">Elimina account</button>
</div>

<div class="card-tvhouse" id="extraFeatures">
  <h2>Funzioni extra</h2>
  <p><strong>Badge utente:</strong> <span id="userBadge">Calcolo...</span></p>
  <p><strong>Seleziona tema:</strong></p>
  <select id="themeSelector" class="btn" style="width:100%;margin-top:5px;">
    <option value="day">Day</option>
    <option value="night">Night</option>
    <option value="matrix">Matrix</option>
    <option value="hight">Hight</option>
    <option value="inverted">Inverted</option>
  </select>
</div>

</div>
</section>

<footer>
<div class="container">
  <strong>ETA Games</strong>
</div>
</footer>

<script>
const auth = firebase.auth();
const db = firebase.firestore();

// Gestione immagine profilo
function resizeToBase64(file, size = 120) {
  return new Promise(resolve => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext('2d');
      const min = Math.min(img.width, img.height);
      const sx = (img.width - min)/2;
      const sy = (img.height - min)/2;
      ctx.drawImage(img, sx, sy, min, min, 0, 0, size, size);
      resolve(canvas.toDataURL('image/jpeg',0.8));
    };
    reader.readAsDataURL(file);
  });
}

// Caricamento dati utente
auth.onAuthStateChanged(async user => {
  if(!user){ window.location.href="login.html"; return; }

  const createdDate = new Date(user.metadata.creationTime);
  const lastLoginDate = new Date(user.metadata.lastSignInTime);

  document.getElementById('username').textContent = user.displayName || "Non impostato";
  document.getElementById('email').textContent = user.email;
  document.getElementById('created').textContent = createdDate.toLocaleDateString();
  document.getElementById('lastLogin').textContent = lastLoginDate.toLocaleDateString();
  document.getElementById('daysRegistered').textContent = Math.floor((new Date() - createdDate)/(1000*60*60*24));

  const doc = await db.collection('users').doc(user.uid).get();
  if(doc.exists){
    if(doc.data().photoBase64) document.getElementById('profileImg').src = doc.data().photoBase64;
    if(doc.data().theme) applyTheme(doc.data().theme);
  }

  // Calcolo badge
  const days = Math.floor((new Date() - createdDate)/(1000*60*60*24));
  let badge="Novellino ðŸ£";
  if(days>30) badge="Gamer Esperto ðŸŽ®";
  if(days>180) badge="Veterano ðŸ†";
  if(days>365) badge="Leggenda ðŸ”¥";
  if(days>730) badge="Maestro Supremo ðŸ‘‘";
  document.getElementById('userBadge').textContent = badge;
});

// Upload immagine profilo
document.getElementById('profileUpload').addEventListener('change', async e=>{
  const file=e.target.files[0];
  if(!file||!file.type.startsWith('image/')){ alert("Carica un'immagine valida"); return; }
  const user = auth.currentUser;
  const base64 = await resizeToBase64(file,120);
  await db.collection('users').doc(user.uid).set({photoBase64:base64},{merge:true});
  document.getElementById('profileImg').src=base64;
  alert("Immagine profilo aggiornata");
});

// Username
document.getElementById('toggleUsername').onclick = ()=>document.getElementById('usernameForm').style.display='block';
document.getElementById('saveUsername').onclick = ()=>{
  const name=document.getElementById('newUsername').value.trim();
  if(!name) return;
  auth.currentUser.updateProfile({displayName:name}).then(async ()=>{
    document.getElementById('username').textContent=name;
    await db.collection('users').doc(auth.currentUser.uid).set({displayName:name},{merge:true});
    alert("Username aggiornato");
  });
};

// Logout, verifica e cancellazione
document.getElementById('logoutBtn').onclick = ()=>auth.signOut().then(()=>location.href="login.html");
document.getElementById('sendVerification').onclick = ()=>auth.currentUser.sendEmailVerification().then(()=>alert("Email inviata"));
document.getElementById('deleteAccount').onclick = ()=>{
  if(confirm("Eliminare l'account definitivamente?")){
    auth.currentUser.delete().then(()=>location.href="login.html");
  }
};

// Copia email
document.getElementById('copyEmail').onclick = ()=>{
  navigator.clipboard.writeText(document.getElementById('email').textContent).then(()=>alert("Email copiata negli appunti"));
};

// ======= Tema dinamico =======
const themeSelector=document.getElementById('themeSelector');
themeSelector.onchange = async ()=>{
  const theme=themeSelector.value;
  applyTheme(theme);
  await db.collection('users').doc(auth.currentUser.uid).set({theme},{merge:true});
};

function applyTheme(theme){
  document.body.className='';
  document.body.classList.add(theme+'-theme');
}
</script>

<style>
/* Temi con variabili */
body.day-theme {--bg:#fdf5e6;--card:#fff;--accent:#e50914;--muted:#111;}
body.night-theme {--bg:#111;--card:#1a1a1a;--accent:#e50914;--muted:#eee;}
body.matrix-theme {--bg:#000;--card:#111;--accent:#0f0;--muted:#0f0;}
body.hight-theme {--bg:#000;--card:#000;--accent:#ff6600;--muted:#fff;}
body.inverted-theme {--bg:#fff;--card:#fff;--accent:#00ffff;--muted:#000;}
</style>

</body>
</html>
